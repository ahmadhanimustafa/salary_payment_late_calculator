<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tracker Pembayaran & Denda Gaji</title>
  <style>
    :root {
      --bg: #050915;
      --panel: #0c1426;
      --border: #1f2937;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --accent: #22c55e;
      --danger: #f97316;
      --shadow: rgba(0, 0, 0, 0.4);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at 20% 20%, #0b1224, #050915 45%),
        radial-gradient(circle at 80% 0%, #0f172a, #050915 50%),
        var(--bg);
      color: var(--text);
    }

    header {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 16px 12px;
    }

    h1 {
      margin: 0;
      font-size: 30px;
      letter-spacing: -0.02em;
    }

    p.lead {
      margin: 10px 0 0;
      color: var(--muted);
      line-height: 1.5;
    }

    .layout {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px 32px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 960px) {
      .layout {
        grid-template-columns: 360px 1fr;
        align-items: start;
      }
    }

    .panel {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0)),
        var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 16px 40px var(--shadow);
    }

    .panel h2 { margin: 0 0 12px; letter-spacing: -0.01em; }

    label { display: flex; flex-direction: column; gap: 6px; color: var(--muted); font-size: 14px; }

    input, select, button {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 12px;
      font-size: 15px;
      background: #0b1220;
      color: var(--text);
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    button {
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #04210f;
      border: none;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
    }

    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .small-btn { padding: 8px 10px; font-size: 13px; border-radius: 8px; }

    .hint { color: var(--muted); font-size: 13px; margin: 4px 0 10px; }

    .schedules-empty {
      padding: 18px;
      text-align: center;
      border: 1px dashed var(--border);
      border-radius: 12px;
      color: var(--muted);
      background: #0b1220;
    }

    .card { border: 1px solid var(--border); border-radius: 12px; padding: 16px; background: #0c1426; margin-bottom: 14px; }
    .card-header { display: flex; justify-content: space-between; gap: 12px; align-items: baseline; flex-wrap: wrap; }
    .badge { padding: 6px 10px; border-radius: 20px; font-size: 12px; background: rgba(34, 197, 94, 0.12); color: #7bed9f; border: 1px solid rgba(34, 197, 94, 0.35); }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 12px; margin: 10px 0; }
    .metric { border: 1px solid var(--border); border-radius: 10px; padding: 12px; background: #0b1220; }
    .metric span { color: var(--muted); font-size: 13px; }
    .metric strong { display: block; margin-top: 6px; font-size: 18px; }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
    th, td { padding: 9px 8px; border-bottom: 1px solid var(--border); }
    th { text-align: left; color: var(--muted); font-weight: 500; }

    .note { background: #0b1220; border: 1px solid var(--border); padding: 12px; border-radius: 10px; color: var(--muted); line-height: 1.6; font-size: 14px; }
    .danger { color: var(--danger); }
  </style>
</head>
<body>
  <header>
    <h1>Tracker Pembayaran & Denda Gaji</h1>
    <p class="lead">
      Catat jadwal gajian bulanan, pembayaran (penuh/parsial), rencana bayar, dan denda progresif.
      Denda 5%/hari mulai hari ke-4 s.d ke-8, lalu +1%/hari setelah hari ke-8 (maks 50% gaji/bulan),
      serta bunga (opsional) setelah lewat 30 hari. Perhitungan otomatis lanjut sampai hari ini jika masih ada sisa gaji.
    </p>
  </header>

  <div class="layout">
    <section class="panel">
      <h2>Tambah kewajiban gaji</h2>
      <form id="salary-form">
        <label>
          Total gaji bulan ini (Rp)
          <input type="number" name="salary" min="0" step="0.01" required placeholder="5000000" />
        </label>

        <label>
          Tanggal jatuh tempo gaji (tanggal gajian setiap bulan)
          <input type="date" name="dueDate" required />
        </label>
        <p class="hint">Gunakan tanggal gajian bulanan (misal tanggal 1 tiap bulan) untuk periode yang dicatat.</p>

        <label>
          Hitung denda sampai tanggal
          <input type="date" name="asOfDate" required />
        </label>
        <p class="hint">Tanggal referensi bisa diubah kapan saja. Jika masih ada sisa gaji, denda otomatis dihitung sampai hari ini.</p>

        <label>
          Estimasi bunga bank per bulan (%), mulai dikenakan setelah lewat 30 hari (opsional)
          <input type="number" name="interestRate" min="0" step="0.01" placeholder="0" />
        </label>

        <button type="submit" style="width: 100%; margin-top: 6px;">Simpan jadwal</button>
      </form>
    </section>

    <section class="panel">
      <div class="card-header" style="margin: -6px 0 8px;">
        <h2 style="margin: 0;">Jadwal gaji</h2>
        <div class="flex" style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="small-btn secondary" id="reset-storage" type="button">Bersihkan semua data</button>
        </div>
      </div>
      <div id="schedule-list"></div>
    </section>
  </div>

  <div class="layout" style="grid-template-columns: 1fr;">
    <section class="panel">
      <h2>Panduan rumus</h2>
      <div class="note">
        <ul>
          <li>Denda 5% per hari untuk hari ke-4 s.d ke-8 atas sisa gaji belum dibayar.</li>
          <li>Mulai hari ke-9 berlaku tambahan 1% per hari. Total denda dasar dibatasi 50% dari gaji.</li>
          <li>Lewat 30 hari, bunga harian = (bunga per bulan / 30) * sisa gaji. Bunga di luar batas 50%.</li>
          <li>Pembayaran parsial mengurangi sisa gaji; denda berikutnya dihitung dari sisa terbaru.</li>
          <li>Jika masih ada sisa gaji, perhitungan otomatis memakai tanggal hari ini meski tanggal referensi lampau.</li>
        </ul>
      </div>
    </section>
  </div>

  <script>
    const storageKey = "salary-tracker-schedules";

    const todayString = () => {
      const now = new Date();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      return `${now.getFullYear()}-${m}-${d}`;
    };

    const parseDate = (value) => {
      const [y, m, d] = value.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d));
    };

    const formatDateInput = (date) => date.toISOString().slice(0, 10);

    const daysLate = (dueDate, targetDate) => {
      const diff = targetDate - dueDate;
      return Math.max(0, Math.floor(diff / (1000 * 60 * 60 * 24)));
    };

    const formatCurrency = (value) => new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", maximumFractionDigits: 0 }).format(value || 0);

    const loadSchedules = () => {
      const stored = localStorage.getItem(storageKey);
      if (!stored) return [];
      try { return JSON.parse(stored); } catch (e) { return []; }
    };

    const saveSchedules = (schedules) => localStorage.setItem(storageKey, JSON.stringify(schedules));

    const uniqueId = () => (crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(16).slice(2)}`);

    const overlapDays = (start, end, rangeStart, rangeEnd = Infinity) => {
      const from = Math.max(start, rangeStart);
      const to = Math.min(end, rangeEnd);
      return Math.max(0, to - from + 1);
    };

    const calculatePenaltySegment = (dueDate, startDate, endDate, outstanding, salary, interestRate) => {
      const startDay = Math.max(1, daysLate(dueDate, startDate) + 1);
      const endDay = daysLate(dueDate, endDate);
      if (endDay < startDay || outstanding <= 0) return { base: 0, interest: 0 };

      const fivePctDays = overlapDays(startDay, endDay, 4, 8);
      const onePctDays = overlapDays(startDay, endDay, 9);
      const basePenalty = fivePctDays * 0.05 * outstanding + onePctDays * 0.01 * outstanding;

      const interestDays = overlapDays(startDay, endDay, 31);
      const dailyInterest = (interestRate || 0) / 100 / 30;
      const interest = interestDays * dailyInterest * outstanding;

      return { base: basePenalty, interest };
    };

    const computeSchedule = (schedule) => {
      const salary = Number(schedule.salary) || 0;
      const dueDate = parseDate(schedule.dueDate);
      const requestedAsOf = parseDate(schedule.asOfDate || todayString());
      const today = parseDate(todayString());
      const interestRate = Number(schedule.interestRate) || 0;
      const payments = [...(schedule.payments || [])].sort((a, b) => parseDate(a.date) - parseDate(b.date));

      let outstanding = salary;
      let paid = 0;
      let basePenaltyTotal = 0;
      let interestTotal = 0;
      let cursorDate = dueDate;

      for (const payment of payments) {
        const payDate = parseDate(payment.date);
        const { base, interest } = calculatePenaltySegment(dueDate, cursorDate, payDate, outstanding, salary, interestRate);
        basePenaltyTotal += base;
        interestTotal += interest;

        const paymentAmount = Math.min(outstanding, Number(payment.amount) || 0);
        outstanding -= paymentAmount;
        paid += paymentAmount;
        cursorDate = payDate;
      }

      const effectiveAsOf = outstanding > 0 ? today : requestedAsOf;
      const finalSegment = calculatePenaltySegment(dueDate, cursorDate, effectiveAsOf, outstanding, salary, interestRate);
      basePenaltyTotal += finalSegment.base;
      interestTotal += finalSegment.interest;

      const cappedBase = Math.min(basePenaltyTotal, salary * 0.5);
      const totalPenalty = cappedBase + interestTotal;
      const totalDue = outstanding + totalPenalty;

      return {
        salary,
        paid,
        outstanding,
        basePenaltyTotal,
        interestTotal,
        cappedBase,
        totalPenalty,
        totalDue,
        payments,
        requestedAsOf,
        effectiveAsOf,
        requestedAsOfInput: formatDateInput(requestedAsOf),
        effectiveAsOfInput: formatDateInput(effectiveAsOf),
      };
    };

    const addSchedule = (data) => {
      const schedules = loadSchedules();
      schedules.push({
        id: uniqueId(),
        salary: data.salary,
        dueDate: data.dueDate,
        asOfDate: data.asOfDate,
        interestRate: data.interestRate,
        payments: [],
        plannedPayments: [],
      });
      saveSchedules(schedules);
    };

    const addPayment = (scheduleId, payload) => {
      const schedules = loadSchedules();
      const schedule = schedules.find((s) => s.id === scheduleId);
      if (!schedule) return;
      const payAmount = payload.mode === "percent" ? (payload.value / 100) * Number(schedule.salary) : payload.value;
      const currentOutstanding = Number(schedule.salary) - (schedule.payments || []).reduce((sum, p) => sum + Number(p.amount || 0), 0);
      const finalAmount = Math.min(payAmount, currentOutstanding);
      const payment = { id: uniqueId(), date: payload.date, amount: finalAmount, mode: payload.mode, original: payload.value };
      schedule.payments = [...(schedule.payments || []), payment];
      saveSchedules(schedules);
    };

    const addPlan = (scheduleId, payload) => {
      const schedules = loadSchedules();
      const schedule = schedules.find((s) => s.id === scheduleId);
      if (!schedule) return;
      const planAmount = payload.mode === "percent" ? (payload.value / 100) * Number(schedule.salary) : payload.value;
      const plan = { id: uniqueId(), date: payload.date, amount: planAmount, mode: payload.mode, original: payload.value };
      schedule.plannedPayments = [...(schedule.plannedPayments || []), plan];
      saveSchedules(schedules);
    };

    const markPlanPaid = (scheduleId, planId) => {
      const schedules = loadSchedules();
      const schedule = schedules.find((s) => s.id === scheduleId);
      if (!schedule) return;
      schedule.plannedPayments = schedule.plannedPayments || [];
      const plan = schedule.plannedPayments.find((p) => p.id === planId);
      if (!plan) return;

      const currentOutstanding = Number(schedule.salary) - (schedule.payments || []).reduce((sum, p) => sum + Number(p.amount || 0), 0);
      const finalAmount = Math.min(plan.amount, currentOutstanding);
      const payment = { ...plan, amount: finalAmount, id: uniqueId() };
      schedule.payments = [...(schedule.payments || []), payment];
      schedule.plannedPayments = schedule.plannedPayments.filter((p) => p.id !== planId);
      saveSchedules(schedules);
    };

    const removePayment = (scheduleId, paymentId) => {
      const schedules = loadSchedules();
      const schedule = schedules.find((s) => s.id === scheduleId);
      if (!schedule) return;
      schedule.payments = (schedule.payments || []).filter((p) => p.id !== paymentId);
      saveSchedules(schedules);
    };

    const removePlan = (scheduleId, planId) => {
      const schedules = loadSchedules();
      const schedule = schedules.find((s) => s.id === scheduleId);
      if (!schedule) return;
      schedule.plannedPayments = (schedule.plannedPayments || []).filter((p) => p.id !== planId);
      saveSchedules(schedules);
    };

    const updateAsOf = (scheduleId, value) => {
      const schedules = loadSchedules();
      const schedule = schedules.find((s) => s.id === scheduleId);
      if (!schedule) return;
      schedule.asOfDate = value;
      saveSchedules(schedules);
    };

    const renderSchedules = () => {
      const container = document.getElementById("schedule-list");
      const schedules = loadSchedules();
      container.innerHTML = "";

      if (!schedules.length) {
        container.innerHTML = '<div class="schedules-empty">Belum ada jadwal gaji. Tambahkan di sisi kiri.</div>';
        return;
      }

      schedules.forEach((schedule) => {
        const summary = computeSchedule(schedule);
        const card = document.createElement("article");
        card.className = "card";

        const paymentsTable = summary.payments.length
          ? `<table>
              <thead>
                <tr>
                  <th>Tanggal</th>
                  <th>Jenis</th>
                  <th>Nilai</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${summary.payments
                  .map((p) => {
                    const kind = p.mode === "percent" ? `${p.original}% (dari gaji)` : "Rupiah";
                    const amount = p.mode === "percent" ? `${formatCurrency(p.amount)} (${p.original}%)` : formatCurrency(p.amount);
                    return `<tr>
                      <td>${p.date}</td>
                      <td>${kind}</td>
                      <td>${amount}</td>
                      <td><button type="button" class="small-btn secondary" data-action="remove-payment" data-id="${schedule.id}" data-payment="${p.id}">Hapus</button></td>
                    </tr>`;
                  })
                  .join("")}
              </tbody>
            </table>`
          : '<div class="muted" style="margin-top: 6px;">Belum ada pembayaran.</div>';

        const plannedTable = (schedule.plannedPayments || []).length
          ? `<table style="margin-top: 10px;">
              <thead>
                <tr>
                  <th>Tanggal</th>
                  <th>Nilai</th>
                  <th colspan="2"></th>
                </tr>
              </thead>
              <tbody>
                ${schedule.plannedPayments
                  .map((p) => {
                    const amount = p.mode === "percent"
                      ? `${formatCurrency((p.original / 100) * Number(schedule.salary))} (${p.original}%)`
                      : formatCurrency(p.amount);
                    return `<tr>
                      <td>${p.date}</td>
                      <td>${amount}</td>
                      <td><button type="button" class="small-btn" data-action="mark-paid" data-id="${schedule.id}" data-plan="${p.id}">Tandai sudah dibayar</button></td>
                      <td><button type="button" class="small-btn secondary" data-action="remove-plan" data-id="${schedule.id}" data-plan="${p.id}">Hapus</button></td>
                    </tr>`;
                  })
                  .join("")}
              </tbody>
            </table>`
          : '<div class="muted" style="margin-top: 8px;">Belum ada rencana pembayaran.</div>';

        card.innerHTML = `
          <div class="card-header">
            <div>
              <strong>Jatuh tempo gajian (per bulan): ${schedule.dueDate}</strong>
              <div class="hint" style="margin: 2px 0 0;">
                Dihitung sampai: ${summary.effectiveAsOfInput}
                ${summary.effectiveAsOfInput !== summary.requestedAsOfInput ? "(otomatis sampai hari ini karena masih ada sisa gaji)" : ""}
              </div>
            </div>
            <span class="badge">${formatCurrency(schedule.salary)}</span>
          </div>

          <div class="grid">
            <div class="metric"><span>Total gaji</span><strong>${formatCurrency(summary.salary)}</strong></div>
            <div class="metric"><span>Sudah dibayar</span><strong>${formatCurrency(summary.paid)}</strong></div>
            <div class="metric"><span>Sisa gaji</span><strong>${formatCurrency(summary.outstanding)}</strong></div>
            <div class="metric"><span>Denda (termasuk bunga)</span><strong class="danger">${formatCurrency(summary.totalPenalty)}</strong></div>
            <div class="metric"><span>Total harus dibayar</span><strong>${formatCurrency(summary.totalDue)}</strong></div>
          </div>

          <div class="note" style="margin-top: 8px;">
            <div>Denda dasar sebelum batas 50%: ${formatCurrency(summary.basePenaltyTotal)}</div>
            <div>Denda dasar setelah batas 50%: ${formatCurrency(summary.cappedBase)}</div>
            <div>Bunga bank setelah 30 hari: ${formatCurrency(summary.interestTotal)} (tarif ${Number(schedule.interestRate || 0)}%/bulan)</div>
          </div>

          <div class="payments">
            <h3 style="margin: 12px 0 8px;">Catat pembayaran</h3>
            <form class="payment-form" data-id="${schedule.id}">
              <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
                <label>
                  Tanggal bayar
                  <input type="date" name="paymentDate" required />
                </label>
                <label>
                  Nilai pembayaran
                  <input type="number" name="paymentValue" step="0.01" min="0" required placeholder="2000000" />
                </label>
                <label>
                  Mode nilai
                  <select name="paymentMode">
                    <option value="amount">Rupiah</option>
                    <option value="percent">Persentase dari gaji</option>
                  </select>
                </label>
              </div>
              <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
                <button type="submit" class="small-btn">Tambah pembayaran</button>
                <button type="button" class="small-btn secondary" data-action="update-asof" data-id="${schedule.id}">Perbarui tanggal hitung</button>
              </div>
              <div class="hint">Pembayaran persentase dihitung dari gaji pokok dan otomatis dibatasi ke sisa gaji.</div>
            </form>

            ${paymentsTable}

            <div class="note" style="margin-top: 12px;">
              <strong>Jadwal pembayaran (rencana)</strong>
              <form class="plan-form" data-id="${schedule.id}" style="margin-top: 10px;">
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
                  <label>
                    Tanggal rencana bayar
                    <input type="date" name="planDate" required />
                  </label>
                  <label>
                    Nilai rencana
                    <input type="number" name="planValue" step="0.01" min="0" required placeholder="1000000" />
                  </label>
                  <label>
                    Mode nilai
                    <select name="planMode">
                      <option value="amount">Rupiah</option>
                      <option value="percent">Persentase dari gaji</option>
                    </select>
                  </label>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
                  <button type="submit" class="small-btn">Tambah rencana bayar</button>
                </div>
                <div class="hint">Rencana belum memengaruhi denda sampai ditandai sudah dibayar.</div>
              </form>
              ${plannedTable}
            </div>
          </div>
        `;

        container.appendChild(card);
      });

      bindPaymentForms();
      bindPlanForms();
    };

    const bindPaymentForms = () => {
      document.querySelectorAll(".payment-form").forEach((form) => {
        const scheduleId = form.dataset.id;
        const asOfBtn = form.querySelector('[data-action="update-asof"]');

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const paymentDate = form.paymentDate.value;
          const paymentValue = Number(form.paymentValue.value);
          const mode = form.paymentMode.value;
          if (!paymentDate || !paymentValue) return;
          addPayment(scheduleId, { date: paymentDate, value: paymentValue, mode });
          renderSchedules();
          form.reset();
        });

        asOfBtn?.addEventListener("click", () => {
          const asOf = prompt("Hitung denda sampai tanggal (YYYY-MM-DD):", todayString());
          if (!asOf) return;
          updateAsOf(scheduleId, asOf);
          renderSchedules();
        });
      });

      document.querySelectorAll('[data-action="remove-payment"]').forEach((btn) => {
        btn.addEventListener("click", () => {
          removePayment(btn.dataset.id, btn.dataset.payment);
          renderSchedules();
        });
      });
    };

    const bindPlanForms = () => {
      document.querySelectorAll(".plan-form").forEach((form) => {
        const scheduleId = form.dataset.id;
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const planDate = form.planDate.value;
          const planValue = Number(form.planValue.value);
          const mode = form.planMode.value;
          if (!planDate || !planValue) return;
          addPlan(scheduleId, { date: planDate, value: planValue, mode });
          renderSchedules();
          form.reset();
        });
      });

      document.querySelectorAll('[data-action="mark-paid"]').forEach((btn) => {
        btn.addEventListener("click", () => {
          markPlanPaid(btn.dataset.id, btn.dataset.plan);
          renderSchedules();
        });
      });

      document.querySelectorAll('[data-action="remove-plan"]').forEach((btn) => {
        btn.addEventListener("click", () => {
          removePlan(btn.dataset.id, btn.dataset.plan);
          renderSchedules();
        });
      });
    };

    document.getElementById("salary-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const data = new FormData(e.target);
      const salary = Number(data.get("salary"));
      const dueDate = data.get("dueDate");
      const asOfDate = data.get("asOfDate");
      const interestRate = Number(data.get("interestRate")) || 0;
      if (!salary || !dueDate || !asOfDate) return;
      addSchedule({ salary, dueDate, asOfDate, interestRate });
      e.target.reset();
      e.target.asOfDate.value = todayString();
      renderSchedules();
    });

    document.getElementById("reset-storage").addEventListener("click", () => {
      if (confirm("Hapus semua jadwal dan catatan pembayaran?")) {
        localStorage.removeItem(storageKey);
        renderSchedules();
      }
    });

    const init = () => {
      document.querySelector('#salary-form [name="asOfDate"]').value = todayString();
      renderSchedules();
    };

    init();
  </script>
</body>
</html>